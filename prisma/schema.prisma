// Prisma Schema for Goal Transformation App
// Using PostgreSQL via Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS ====================

model User {
  id                   String   @id @default(cuid())
  email                String   @unique
  passwordHash         String
  displayName          String?
  avatarUrl            String?
  themePreference      String   @default("minimal")
  notificationSettings String   @default("{}") // JSON string
  onboardingCompleted  Boolean  @default(false)
  onboardingData       String?  // JSON string
  timezone             String   @default("UTC")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  goals             Goal[]
  challenges        Challenge[]
  challengeLogs     ChallengeLog[]
  diaryEntries      DiaryEntry[]
  dailySurveys      DailySurvey[]
  conversations     Conversation[]
  progressSnapshots ProgressSnapshot[]
  preferences       UserPreferences?
}

// ==================== GOALS ====================

model GoalDomain {
  id          Int     @id @default(autoincrement())
  name        String
  icon        String?
  color       String?
  description String?
  examples    String? // JSON array string

  goals              Goal[]
  challengeTemplates ChallengeTemplate[]
}

model Goal {
  id                  String    @id @default(cuid())
  userId              String
  domainId            Int?
  title               String
  description         String?
  currentState        String?
  desiredState        String?
  aiAnalysis          String?   // JSON string
  scientificFramework String?
  difficultyLevel     Int       @default(5)
  realityShiftEnabled Boolean   @default(false)
  status              String    @default("active")
  targetDate          DateTime?
  startedAt           DateTime  @default(now())
  completedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  domain            GoalDomain?        @relation(fields: [domainId], references: [id])
  challenges        Challenge[]
  diaryEntries      DiaryEntry[]
  conversations     Conversation[]
  progressSnapshots ProgressSnapshot[]

  @@index([userId])
  @@index([status])
}

// ==================== CHALLENGES ====================

model ChallengeTemplate {
  id                   String  @id @default(cuid())
  domainId             Int?
  title                String
  description          String
  instructions         String?
  durationMinutes      Int?
  difficulty           Int
  isRealityShift       Boolean @default(false)
  scientificReferences String? // JSON string
  tags                 String? // JSON array string
  successCriteria      String?
  createdAt            DateTime @default(now())

  domain     GoalDomain? @relation(fields: [domainId], references: [id])
  challenges Challenge[]
}

model Challenge {
  id                  String    @id @default(cuid())
  goalId              String?
  userId              String
  templateId          String?
  title               String
  description         String
  personalizationNotes String?
  difficulty          Int
  isRealityShift      Boolean   @default(false)
  scheduledDate       DateTime
  scheduledTime       String?
  status              String    @default("pending")
  completedAt         DateTime?
  skippedReason       String?
  createdAt           DateTime  @default(now())

  goal     Goal?              @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  template ChallengeTemplate? @relation(fields: [templateId], references: [id])
  logs     ChallengeLog[]
  diaryEntries DiaryEntry[]

  @@index([userId, scheduledDate])
  @@index([status])
}

model ChallengeLog {
  id             String   @id @default(cuid())
  challengeId    String
  userId         String
  completedAt    DateTime @default(now())
  difficultyFelt Int?
  satisfaction   Int?
  notes          String?
  evidenceUrls   String?  // JSON array string
  insights       String?
  aiFeedback     String?  // JSON string

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== DIARY ====================

model DiaryEntry {
  id                   String   @id @default(cuid())
  userId               String
  goalId               String?
  challengeId          String?
  entryType            String   @default("voice")
  audioUrl             String?
  audioDurationSeconds Int?
  transcript           String?
  aiSummary            String?
  aiInsights           String?  // JSON string
  moodDetected         String?
  moodScore            Int?
  keyThemes            String?  // JSON array string
  createdAt            DateTime @default(now())

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal      Goal?      @relation(fields: [goalId], references: [id], onDelete: SetNull)
  challenge Challenge? @relation(fields: [challengeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
}

// ==================== SURVEYS ====================

model DailySurvey {
  id               String   @id @default(cuid())
  userId           String
  surveyDate       DateTime
  energyLevel      Int
  motivationLevel  Int
  overallMood      Int
  sleepQuality     Int?
  stressLevel      Int?
  biggestWin       String?
  biggestBlocker   String?
  gratitudeNote    String?
  tomorrowIntention String?
  customMetrics    String?  // JSON string
  completionLevel  String   @default("minimum")
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, surveyDate])
  @@index([userId, surveyDate])
}

// ==================== CONVERSATIONS ====================

model Conversation {
  id               String   @id @default(cuid())
  userId           String
  goalId           String?
  conversationType String
  title            String?
  messages         String   @default("[]") // JSON array string
  context          String?  // JSON string
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal Goal? @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId])
}

// ==================== PROGRESS ====================

model ProgressSnapshot {
  id                    String   @id @default(cuid())
  userId                String
  goalId                String
  snapshotDate          DateTime
  challengesCompleted   Int      @default(0)
  challengesSkipped     Int      @default(0)
  streakCount           Int      @default(0)
  avgDifficultyFelt     Float?
  avgSatisfaction       Float?
  diaryEntriesCount     Int      @default(0)
  aiProgressAssessment  String?
  progressScore         Int?
  createdAt             DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([goalId, snapshotDate])
  @@index([goalId, snapshotDate])
}

// ==================== PREFERENCES ====================

model UserPreferences {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  displayName               String?
  preferredDifficulty       Int?
  challengesPerDay          Int?
  realityShiftEnabled       Boolean?
  preferredChallengeTime    String?
  focusAreas                String?  // JSON string
  avoidAreas                String?  // JSON string
  aiPersonality             String?
  includeScientificBasis    Boolean?
  challengeLengthPreference String?
  notificationsEnabled      Boolean?
  dailyReminderTime         String?
  streakReminders           Boolean?
  theme                     String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
